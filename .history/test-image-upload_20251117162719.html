<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload de Imagens - Exemplo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f9fdf9;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #f0faf0;
            border-color: #45a049;
        }

        .upload-area.dragover {
            background: #e8f5e9;
            border-color: #2e7d32;
        }

        .upload-area i {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .upload-area h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .upload-area p {
            color: #666;
            font-size: 14px;
        }

        #file-input {
            display: none;
        }

        /* Progress Bar */
        .progress-container {
            display: none;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        /* Image Gallery */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .image-card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-card:hover .image-overlay {
            opacity: 1;
        }

        .btn-delete {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        /* Info Box */
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box h3 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #0d47a1;
        }

        .info-box li {
            margin: 5px 0;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∑ Upload de Imagens para Supabase</h1>
        <p class="subtitle">Gerencie as imagens dos seus an√∫ncios</p>

        <div class="info-box">
            <h3>‚ÑπÔ∏è Instru√ß√µes</h3>
            <ul>
                <li>Tamanho m√°ximo: 5MB por imagem</li>
                <li>Formatos aceitos: JPG, PNG, WebP</li>
                <li>M√°ximo de 10 imagens por propriedade</li>
                <li>Clique ou arraste arquivos para fazer upload</li>
            </ul>
        </div>

        <!-- Upload Area -->
        <div class="upload-area" id="upload-area">
            <div style="font-size: 48px; color: #4CAF50; margin-bottom: 15px;">üìÅ</div>
            <h3>Clique ou arraste imagens aqui</h3>
            <p>Selecione uma ou m√∫ltiplas imagens</p>
            <input type="file" id="file-input" accept="image/jpeg,image/jpg,image/png,image/webp" multiple>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container" id="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill">0%</div>
            </div>
            <p id="progress-text" style="margin-top: 10px; text-align: center; color: #666;"></p>
        </div>

        <!-- Loading Spinner -->
        <div class="spinner" id="spinner"></div>

        <!-- Messages -->
        <div class="message success" id="success-message"></div>
        <div class="message error" id="error-message"></div>

        <!-- Image Gallery -->
        <div>
            <h2 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Imagens Carregadas</h2>
            <div class="image-gallery" id="image-gallery">
                <p style="color: #999; grid-column: 1/-1; text-align: center;">Nenhuma imagem carregada ainda</p>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="../../scripts/site-config.js"></script>
    <script src="../../scripts/supabase-client.js"></script>
    <script src="../../scripts/image-upload.js"></script>

    <script>
        // ID da propriedade (exemplo - voc√™ deve obter dinamicamente)
        const PROPERTY_ID = 'example-property-id'; // Substitua por um ID real

        // Elementos do DOM
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const imageGallery = document.getElementById('image-gallery');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const spinner = document.getElementById('spinner');

        // Obt√©m o cliente Supabase
        const supabase = window.supabaseClient;

        // Verifica se est√° autenticado
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                showError('Voc√™ precisa estar logado para fazer upload de imagens.');
                uploadArea.style.display = 'none';
                return false;
            }
            return true;
        }

        // Event Listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFiles);

        // Drag and Drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles({ target: { files: e.dataTransfer.files } });
        });

        // Manipula arquivos selecionados
        async function handleFiles(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            if (!await checkAuth()) return;

            // Mostra progresso
            progressContainer.style.display = 'block';
            hideMessages();

            // Faz upload
            const result = await window.ImageUploadManager.uploadMultipleImages(
                files,
                PROPERTY_ID,
                supabase,
                (progress) => {
                    const percent = Math.round((progress.current / progress.total) * 100);
                    progressFill.style.width = percent + '%';
                    progressFill.textContent = percent + '%';
                    progressText.textContent = `Enviando ${progress.current} de ${progress.total}: ${progress.fileName}`;
                }
            );

            // Esconde progresso
            progressContainer.style.display = 'none';

            // Mostra resultados
            if (result.success) {
                showSuccess(`${result.results.length} imagem(ns) enviada(s) com sucesso!`);
                await loadImages();
            } else {
                let errorMsg = 'Alguns arquivos n√£o puderam ser enviados:\n';
                result.errors.forEach(err => {
                    errorMsg += `\n‚Ä¢ ${err.fileName}: ${err.error}`;
                });
                showError(errorMsg);
                
                // Se algumas foram enviadas, recarrega
                if (result.results.length > 0) {
                    await loadImages();
                }
            }

            // Limpa input
            fileInput.value = '';
        }

        // Carrega imagens existentes
        async function loadImages() {
            spinner.style.display = 'block';
            imageGallery.innerHTML = '';

            const images = await window.ImageUploadManager.getPropertyImages(PROPERTY_ID, supabase);

            spinner.style.display = 'none';

            if (images.length === 0) {
                imageGallery.innerHTML = '<p style="color: #999; grid-column: 1/-1; text-align: center;">Nenhuma imagem carregada ainda</p>';
                return;
            }

            images.forEach(img => {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.innerHTML = `
                    <img src="${img.publicUrl}" alt="${img.alt || 'Imagem da propriedade'}">
                    <div class="image-overlay">
                        <button class="btn-delete" onclick="deleteImage('${img.id}')">
                            üóëÔ∏è Deletar
                        </button>
                    </div>
                `;
                imageGallery.appendChild(card);
            });
        }

        // Deleta uma imagem
        async function deleteImage(imageId) {
            if (!confirm('Tem certeza que deseja deletar esta imagem?')) return;

            spinner.style.display = 'block';
            const result = await window.ImageUploadManager.deletePropertyImage(imageId, supabase);
            spinner.style.display = 'none';

            if (result.success) {
                showSuccess('Imagem deletada com sucesso!');
                await loadImages();
            } else {
                showError('Erro ao deletar imagem: ' + result.error);
            }
        }

        // Fun√ß√µes auxiliares para mensagens
        function showSuccess(msg) {
            successMessage.textContent = msg;
            successMessage.classList.add('show');
            setTimeout(() => successMessage.classList.remove('show'), 5000);
        }

        function showError(msg) {
            errorMessage.textContent = msg;
            errorMessage.classList.add('show');
        }

        function hideMessages() {
            successMessage.classList.remove('show');
            errorMessage.classList.remove('show');
        }

        // Exp√µe deleteImage globalmente
        window.deleteImage = deleteImage;

        // Carrega imagens ao iniciar
        checkAuth().then(isAuth => {
            if (isAuth) {
                loadImages();
            }
        });
    </script>
</body>
</html>
